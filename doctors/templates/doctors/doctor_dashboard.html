{# doctors/templates/doctors/doctor_dashboard.html #}
{% extends "base.html" %}

{% block title %}Doctor Clinical Dashboard · Campus Medical Center{% endblock %}

{% block content %}
<div class="page-container max-width">

    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                {% if doctor %}
                    Welcome, Dr. {{ doctor.first_name }} {{ doctor.last_name }}
                {% else %}
                    Doctor Clinical Dashboard
                {% endif %}
            </h1>
            <p class="page-subtitle">
                Find a patient, review their encounters, update clinical notes, prescribe medications, and view billing.
            </p>
        </div>

        {% if doctor %}
            <div class="page-header-aside">
                <div class="pill pill-muted">
                    {{ doctor.specialization }}
                    {% if doctor.department %}
                        &middot; {{ doctor.department.name }}
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    {% if doctor %}
        <!-- Today's Schedule -->
	<div class="card mb-lg">
    		<div class="card-header">
        		<h2 class="card-title">Today's Schedule</h2>
        		<p class="card-subtitle">
            		{{ today|date:"M d, Y" }} &middot;
            		{% if todays_appointments %}
                		{{ todays_appointments|length }} appointment{{ todays_appointments|length|pluralize }}
           		{% else %}
                		No appointments scheduled for today.
            		{% endif %}
        		</p>
    		</div>

    		{% if todays_appointments %}
        	
<div class="card mb-lg">
    <div class="card-header">
        <h2 class="card-title">Today's Schedule</h2>
        <p class="card-subtitle">
            {{ today|date:"M d, Y" }} ·
            {% if todays_appointments %}
                {{ todays_appointments|length }} appointment{{ todays_appointments|length|pluralize }}
            {% else %}
                No appointments scheduled for today.
            {% endif %}
        </p>
    </div>

    {% if todays_appointments %}
        <div class="card-body">
            <ul class="list-vertical">

                {% for appt in todays_appointments %}
                <li class="list-item">
                    <div class="list-item-main">
                        <div class="list-item-title">
                            {{ appt.appointment_date|date:"M d, Y" }}
                            &middot;
                            {{ appt.start_time|time:"g:i A" }} – {{ appt.end_time|time:"g:i A" }}
                            &middot;
                            {{ appt.patient.first_name }} {{ appt.patient.last_name }}
                            {% if appt.patient.mrn %}
                                (MRN {{ appt.patient.mrn }})
                            {% endif %}
                        </div>

                        <div class="list-item-sub">
                            {% if appt.reason %}
                                Reason: {{ appt.reason }} &middot;
                            {% endif %}
                            Status:
                            <span class="badge">{{ appt.get_status_display }}</span>
                        </div>
                    </div>

                    <div class="list-item-actions">
                        <a href="{% url 'appointments:appointment_detail' appt.pk %}"
                           class="btn btn-xs btn-outline">
                            View
                        </a>

                        <a href="{% url 'doctors:dashboard' %}?q={{ appt.patient.mrn|urlencode }}"
                           class="btn btn-xs btn-primary">
                            Open Patient
                        </a>

                        <a href="{% url 'encounters:create_from_appointment' appt.pk %}"
                           class="btn btn-xs btn-success">
                            Start Visit
                        </a>
                    </div>
                </li>
                {% endfor %}

            </ul>
        </div>
    {% endif %}
</div>



    {% endif %}
</div>
    {% endif %}

    <!-- Search Card -->
    <div class="card mb-lg">
        <div class="card-header">
            <h2 class="card-title">Find a Patient</h2>
            <p class="card-subtitle">
                Search by name, MRN, phone, or email.
            </p>
        </div>
        <div class="card-body">
            <form method="get" class="search-form">
                <div class="search-input-group">
                    <input
                        type="text"
                        name="q"
                        value="{{ query }}"
                        placeholder="Start typing a name, MRN, phone, or email…"
                        class="input-text"
                    />
                    <button type="submit" class="btn btn-primary">
                        Search
                    </button>
                </div>
            </form>

            {% if search_error %}
                <p class="text-muted mt-sm">{{ search_error }}</p>
            {% endif %}
        </div>
    </div>

    {# Only show dashboard if a patient was resolved #}
    {% if patient %}
        <!-- Patient Summary -->
        <div class="card mb-lg">
            <div class="card-header">
                <h2 class="card-title">
                    {{ patient.first_name }} {{ patient.last_name }}
                </h2>
                <p class="card-subtitle">
                    MRN: {{ patient.mrn }} &middot;
                    DOB: {{ patient.dob|date:"M d, Y" }}
                </p>
            </div>
            <div class="card-body grid-2-cols">
                <div class="summary-item">
                    <div class="summary-label">Phone</div>
                    <div class="summary-value">{{ patient.phone|default:"—" }}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Email</div>
                    <div class="summary-value">{{ patient.email|default:"—" }}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Address</div>
                    <div class="summary-value">
                        {% if patient.address %}
                            {{ patient.address }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Primary Insurance</div>
                    <div class="summary-value">
                        {% with patient.policies.all|first as primary_policy %}
                            {% if primary_policy %}
                                {{ primary_policy.payer_name }} – {{ primary_policy.plan_name }}
                            {% else %}
                                —
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Doctor Workbench -->
        <div class="dashboard-grid">

            {# Encounters list for this patient #}
            <section class="card">
                <div class="card-header">
                    <h3 class="card-title-sm">Encounters</h3>
                    <p class="card-subtitle">
                        Select an encounter to review and update details.
                    </p>
                </div>
                <div class="card-body">
                    {% if encounters %}
                        <ul class="list-vertical">
                            {% for enc in encounters %}
                                <li class="list-item {% if active_encounter and active_encounter.encounter_id == enc.encounter_id %}is-active{% endif %}">
                                    <a
                                        href="?q={{ query|urlencode }}&patient_id={{ patient.id }}&encounter_id={{ enc.encounter_id }}"
                                        class="list-item-main list-item-link"
                                    >
                                        <div class="list-item-title">
                                            {{ enc.encounter_date|date:"M d, Y" }}
                                            · {{ enc.get_visit_type_display }}
                                        </div>
                                        <div class="list-item-sub">
                                            With Dr. {{ enc.doctor.first_name }} {{ enc.doctor.last_name }}
                                            {% if enc.diagnosis_summary %}
                                                <br>Dx: {{ enc.diagnosis_summary }}
                                            {% endif %}
                                            {% if enc.treatment_plan %}
                                                <br>Plan: {{ enc.treatment_plan|truncatechars:80 }}
                                            {% endif %}
                                        </div>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No encounters found for this patient.</p>
                    {% endif %}
                </div>
            </section>

            {# Encounter details + editable clinical notes #}
            <section class="card">
                <div class="card-header">
                    <h3 class="card-title-sm">Encounter Details &amp; Notes</h3>
                </div>
                <div class="card-body">
                    {% if active_encounter %}
                        <div class="mb-md">
                            <div class="summary-item">
                                <div class="summary-label">Date</div>
                                <div class="summary-value">
                                    {{ active_encounter.encounter_date|date:"M d, Y" }}
                                </div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Visit Type</div>
                                <div class="summary-value">
                                    {{ active_encounter.get_visit_type_display }}
                                </div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Doctor</div>
                                <div class="summary-value">
                                    Dr. {{ active_encounter.doctor.first_name }} {{ active_encounter.doctor.last_name }}
                                </div>
                            </div>
                        </div>

                        <form method="post" class="stacked-form">
                            {% csrf_token %}
                            <input type="hidden" name="patient_id" value="{{ patient.id }}">
                            <input type="hidden" name="encounter_id" value="{{ active_encounter.encounter_id }}">
                            <input type="hidden" name="action" value="update_encounter">

                            <div class="form-group">
                                <label for="id_diagnosis_summary" class="form-label">Diagnosis Summary</label>
                                <textarea
                                    id="id_diagnosis_summary"
                                    name="diagnosis_summary"
                                    rows="2"
                                    class="input-textarea"
                                >{{ active_encounter.diagnosis_summary }}</textarea>
                            </div>

                            <div class="form-group">
                                <label for="id_treatment_plan" class="form-label">Treatment Plan</label>
                                <textarea
                                    id="id_treatment_plan"
                                    name="treatment_plan"
                                    rows="3"
                                    class="input-textarea"
                                >{{ active_encounter.treatment_plan }}</textarea>
                            </div>

                            <div class="form-group">
                                <label for="id_notes" class="form-label">Clinical Notes</label>
                                <textarea
                                    id="id_notes"
                                    name="notes"
                                    rows="4"
                                    class="input-textarea"
                                >{{ active_encounter.notes }}</textarea>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    Save Encounter Notes
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <p class="text-muted">
                            Select an encounter from the list to view and edit details.
                        </p>
                    {% endif %}
                </div>
            </section>

            {# Medications for the active encounter + add prescription #}
            <section class="card">
                <div class="card-header">
                    <h3 class="card-title-sm">Medications for Encounter</h3>
                </div>
                <div class="card-body">
                    {% if active_encounter %}
                        {% if encounter_prescriptions %}
                            

<ul class="list-vertical mb-md">
    {% for presc in encounter_prescriptions %}
        <li class="list-item">
            <div class="list-item-main">
                <div class="list-item-title">
                    {{ presc.medication.generic_name }}
                    {% if presc.medication.brand_name %}
                        ({{ presc.medication.brand_name }})
                    {% endif %}
                    – {{ presc.medication.form }}
                    {% if presc.medication.strength %}
                        · {{ presc.medication.strength }}
                    {% endif %}
                </div>
                <div class="list-item-sub">
                    Dosage: {{ presc.dosage }}<br>
                    {{ presc.frequency_per_day }}×/day
                    for {{ presc.duration_days }} days
                    {% if presc.instructions %}
                        <br>Instructions: {{ presc.instructions }}
                    {% endif %}
                </div>
            </div>

            <div class="list-item-actions">
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_prescription">
                    <input type="hidden" name="patient_id" value="{{ patient.id }}">
                    <input type="hidden" name="encounter_id" value="{{ active_encounter.encounter_id }}">
                    <input type="hidden" name="prescription_id" value="{{ presc.prescription_id }}">
                    <button type="submit" class="btn btn-xs btn-danger">
                        Delete
                    </button>
                </form>
            </div>
        </li>
    {% endfor %}
</ul>


                        {% else %}
                            <p class="text-muted">No medications prescribed in this encounter yet.</p>
                        {% endif %}



<h3 class="card-title-sm mt-lg">Procedures for Encounter</h3>

{% if active_encounter %}
    {% with active_encounter.procedures.all as procedures %}
        {% if procedures %}
            <ul class="list-vertical mb-md">
                {% for ep in procedures %}
                    <li class="list-item">
                        <div class="list-item-main">
                            <div class="list-item-title">
                                {{ ep.procedure.name }}
                            </div>
                            <div class="list-item-sub">
                                Quantity: {{ ep.quantity }}
                                <br>Unit Price: {{ ep.procedure.base_price }}
                            </div>
                        </div>

                        <div class="list-item-actions">
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete_procedure">
                                <input type="hidden" name="patient_id" value="{{ patient.id }}">
                                <input type="hidden" name="encounter_id" value="{{ active_encounter.encounter_id }}">
                                <input type="hidden" name="procedure_id" value="{{ ep.id }}">
                                <button type="submit" class="btn btn-xs btn-danger">
                                    Delete
                                </button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No procedures added for this encounter yet.</p>
        {% endif %}
    {% endwith %}
{% endif %}


                        <hr class="divider">



<h4 class="card-title-xs mb-sm">Add Medications (Multiple)</h4>

<form method="post" class="stacked-form">
    {% csrf_token %}
    <input type="hidden" name="patient_id" value="{{ patient.id }}">
    <input type="hidden" name="encounter_id" value="{{ active_encounter.encounter_id }}">
    <input type="hidden" name="action" value="batch_add_prescriptions">

    <div id="medication-container">

        <!-- Row Template -->
        <div class="med-row mb-md medication-item">
            <div class="form-group">
                <label class="form-label">Medication</label>
                <select name="medication_id[]" class="input-select" required>
                    <option value="">Select medication…</option>
                    {% for med in medication_options %}
                        <option value="{{ med.medication_id }}">
                            {{ med.generic_name }}
                            {% if med.brand_name %}({{ med.brand_name }}){% endif %}
                            {% if med.strength %} – {{ med.strength }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group grid-3-cols">
                <div>
                    <label class="form-label">Dosage</label>
                    <input type="text" name="dosage[]" class="input-text" required>
                </div>
                <div>
                    <label class="form-label">Times/day</label>
                    <input type="number" name="frequency_per_day[]" class="input-text" min="1" value="1" required>
                </div>
                <div>
                    <label class="form-label">Duration (days)</label>
                    <input type="number" name="duration_days[]" class="input-text" min="1" value="7" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Instructions</label>
                <input type="text" name="instructions[]" class="input-text">
            </div>

            <button type="button" class="btn btn-xs btn-danger remove-med-row">Remove</button>
            <hr>
        </div>

    </div>

    <button type="button" id="add-med-row" class="btn btn-secondary mb-md">
        + Add Another Medication
    </button>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">
            Submit All
        </button>
    </div>
</form>


<h4 class="card-title-xs mb-sm">Add Procedures (Multiple)</h4>

<form method="post" class="stacked-form">
    {% csrf_token %}
    <input type="hidden" name="patient_id" value="{{ patient.id }}">
    <input type="hidden" name="encounter_id" value="{{ active_encounter.encounter_id }}">
    <input type="hidden" name="action" value="batch_add_procedures">

    <div id="procedure-container">

        <!-- Template row -->
        <div class="proc-row mb-md procedure-item">
            <div class="form-group">
                <label class="form-label">Procedure</label>
                <select name="procedure_id[]" class="input-select" required>
                    <option value="">Select procedure…</option>
                    {% for proc in procedure_options %}
                        <option value="{{ proc.procedure_id }}">
                            {{ proc.name }} – {{ proc.unit_price }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Quantity</label>
                <input type="number" name="quantity[]" class="input-text" min="1" value="1" required>
            </div>

            <button type="button" class="btn btn-xs btn-danger remove-proc-row">Remove</button>
            <hr>
        </div>

    </div>

    <button type="button" id="add-proc-row" class="btn btn-secondary mb-md">+ Add Another Procedure</button>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Submit All</button>
    </div>
</form>




                    {% else %}
                        <p class="text-muted">
                            Select an encounter to review and prescribe medications.
                        </p>
                    {% endif %}
                </div>
            </section>

            {# Billing summary for the active encounter #}
            <section class="card">
                <div class="card-header">
                    <h3 class="card-title-sm">Billing for Encounter</h3>
                </div>
                <div class="card-body">
                    {% if active_encounter %}
                        {% if encounter_bill %}
                            <div class="mb-md">
                                <div class="summary-item">
                                    <div class="summary-label">Bill #</div>
                                    <div class="summary-value">{{ encounter_bill.bill_id }}</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Bill Date</div>
                                    <div class="summary-value">
                                        {{ encounter_bill.bill_date|date:"M d, Y" }}
                                    </div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Total Amount</div>
                                    <div class="summary-value">
                                        {{ encounter_bill.total_amount }}
                                    </div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Status</div>
                                    <div class="summary-value">
                                     <form method="post" style="display: inline-block;">
            				{% csrf_token %}
            				<input type="hidden" name="patient_id" value="{{ patient.id }}">
            				<input type="hidden" name="encounter_id" value="{{ active_encounter.encounter_id }}">
            				<input type="hidden" name="action" value="update_bill_status">

            				<select name="bill_status" class="input-select">
                				<option value="PENDING" {% if encounter_bill.status == "PENDING" %}selected{% endif %}>Pending</option>
                				<option value="PAID" {% if encounter_bill.status == "PAID" %}selected{% endif %}>Paid</option>
                				<option value="CANCELLED" {% if encounter_bill.status == "CANCELLED" %}selected{% endif %}>Cancelled</option>
            				</select>

            				<button type="submit" class="btn btn-xs btn-primary">Save</button>
        				</form>   
                                    </div>
                                </div>
                            </div>

                            {% if encounter_bill.bill_lines.all %}
                                <h4 class="card-title-xs mb-sm">Bill Line Items</h4>
                                <ul class="list-vertical mb-md">
                                    {% for line in encounter_bill.bill_lines.all %}
                                        <li class="list-item">
                                            <div class="list-item-main">
                                                <div class="list-item-title">
                                                    {% if line.line_type == 'MEDICATION' and line.medication %}
                                                        {{ line.medication.generic_name }}
                                                        {% if line.medication.brand_name %}
                                                            ({{ line.medication.brand_name }})
                                                        {% endif %}
                                                    {% elif line.line_type == 'PROCEDURE' and line.procedure %}
                                                        {{ line.procedure.name }}
                                                    {% else %}
                                                        {{ line.description1|default:"Service" }}
                                                    {% endif %}
                                                </div>
                                                <div class="list-item-sub">
                                                    {{ line.quantity }} × {{ line.unit_price }}
                                                    = {{ line.calculated_total }}
                                                    <br>Type: {{ line.get_line_type_display }}
                                                </div>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">
                                No bill exists yet for this encounter.
                            </p>
                        {% endif %}

                        <form method="post" class="mt-md">
                            {% csrf_token %}
                            <input type="hidden" name="patient_id" value="{{ patient.id }}">
                            <input type="hidden" name="encounter_id" value="{{ active_encounter.encounter_id }}">
                            <input type="hidden" name="action" value="sync_billing">

                            <p class="text-muted mb-sm">
                                Synchronize billing with the current encounter notes, procedures, and medications.
                            </p>

                            <button type="submit" class="btn btn-outline">
                                Update / Generate Bill for Encounter
                            </button>
                        </form>
                    {% else %}
                        <p class="text-muted">
                            Select an encounter to view billing details.
                        </p>
                    {% endif %}
                </div>
            </section>
        </div>
    {% endif %}
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("medication-container");
    const addButton = document.getElementById("add-med-row");

    // 添加新行
    addButton.addEventListener("click", function () {
        const firstRow = container.querySelector(".med-row");
        const newRow = firstRow.cloneNode(true);

        // 清空内容
        newRow.querySelectorAll("input").forEach(i => i.value = "");
        newRow.querySelector("select").value = "";

        container.appendChild(newRow);

        // 删除按钮
        newRow.querySelector(".remove-med-row").addEventListener("click", function () {
            if (document.querySelectorAll(".med-row").length > 1) {
                newRow.remove();
            }
        });
    });

    // 第一行的删除按钮（不能删到 0 行）
    document.querySelectorAll(".remove-med-row").forEach(btn => {
        btn.addEventListener("click", function () {
            if (document.querySelectorAll(".med-row").length > 1) {
                btn.closest(".med-row").remove();
            }
        });
    });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {

    /* -------------------------- */
    /*  PROCEDURE - 动态新增行     */
    /* -------------------------- */
    const procContainer = document.getElementById("procedure-container");
    const addProcButton = document.getElementById("add-proc-row");

    addProcButton.addEventListener("click", function () {
        const firstRow = procContainer.querySelector(".proc-row");
        const newRow = firstRow.cloneNode(true);

        // 清空内容
        newRow.querySelector("select").value = "";
        newRow.querySelector("input[name='quantity[]']").value = 1;

        procContainer.appendChild(newRow);

        // 删除按钮绑定
        newRow.querySelector(".remove-proc-row").addEventListener("click", function () {
            if (document.querySelectorAll(".proc-row").length > 1) {
                newRow.remove();
            }
        });
    });

    // 第一行的删除按钮
    document.querySelectorAll(".remove-proc-row").forEach(btn => {
        btn.addEventListener("click", function () {
            if (document.querySelectorAll(".proc-row").length > 1) {
                btn.closest(".proc-row").remove();
            }
        });
    });

});
</script>



{% endblock %}
